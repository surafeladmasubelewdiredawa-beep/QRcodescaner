<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="jsQR.min.js"></script>
  <script src="jspdf.umd.min.js"></script>
  <script src="jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #6300ee;
      --primary-dark: #3600b3;
      --secondary: #03dac6;
      --error: #b00020;
      --success: #018787;
      --warning: #ffa200;
      --background: #121212;
      --surface: #1e1e1e;
      --on-surface: #ffffff;
      --on-surface-secondary: rgba(255, 255, 255, 0.7);
      --error-text: #ff6b6b;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: #e0e0e0;
      background-color: var(--background);
      position: relative;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 12.6px; /* Reduced from ~18px */
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
    }
    
    .scanner-section {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #000;
    }
    
    .controls-container {
      padding: 10.5px; /* Reduced from 15px */
      background-color: rgba(30, 30, 30, 0.9);
      width: 100%;
      z-index: 10;
    }
    
    .history-section {
      position: fixed;
      top: 0;
      right: 0;
      width: 224px; /* Reduced from 320px */
      height: 100vh;
      background-color: var(--surface);
      padding: 10.5px; /* Reduced from 15px */
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
      overflow-y: auto;
      z-index: 100;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .history-section.active {
      transform: translateX(0);
    }
    
    .toggle-history {
      position: fixed;
      top: 10.5px; /* Reduced from 15px */
      right: 10.5px; /* Reduced from 15px */
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px; /* Reduced from 50px */
      height: 35px; /* Reduced from 50px */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 101;
      cursor: pointer;
      font-size: 14px; /* Reduced from 20px */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .status {
      text-align: center;
      margin: 7px 0; /* Reduced from 10px */
      font-size: 11.2px; /* Reduced from 16px */
      font-weight: bold;
      color: var(--on-surface-secondary);
      min-height: 14px; /* Reduced from 20px */
    }
    
    .timer {
      text-align: center;
      font-size: 11.2px; /* Reduced from 16px */
      font-weight: bold;
      color: var(--secondary);
      margin-bottom: 7px; /* Reduced from 10px */
      display: none;
    }
    
    .scanner-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: none;
    }
    
    .scanner-guide {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 70%;
      border: 1.4px dashed rgba(255, 255, 255, 0.5); /* Reduced from 2px */
      border-radius: 7px; /* Reduced from 10px */
    }
    
    #result {
      position: absolute;
      top: 14px; /* Reduced from 20px */
      left: 14px; /* Reduced from 20px */
      right: 14px; /* Reduced from 20px */
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(3px);
      color: #fff;
      padding: 10.5px; /* Reduced from 15px */
      border-radius: 3.5px; /* Reduced from 5px */
      font-size: 9.8px; /* Reduced from 14px */
      font-weight: bold;
      display: none;
      z-index: 10;
      text-align: center;
      word-break: break-all;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 7px; /* Reduced from 10px */
    }
    
    .btn {
      padding: 8.4px 14px; /* Reduced from 12px 20px */
      font-size: 9.8px; /* Reduced from 14px */
      font-weight: bold;
      border: none;
      border-radius: 35px; /* Reduced from 50px */
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 56px; /* Reduced from 80px */
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1.4px); /* Reduced from 2px */
    }
    
    .btn:active {
      transform: translateY(0.7px); /* Reduced from 1px */
      box-shadow: 0 0.7px 1.4px rgba(0, 0, 0, 0.2); /* Reduced from 1px 2px */
    }
    
    .btn-icon {
      font-size: 12.6px; /* Reduced from 18px */
      margin-bottom: 3.5px; /* Reduced from 5px */
    }
    
    .btn-file { 
      background-color: var(--warning);
    }
    .btn-start { 
      background-color: var(--success);
    }
    .btn-stop { 
      background-color: var(--error);
    }
    .btn-copy { 
      background-color: var(--primary);
    }
    .btn-clear { 
      background-color: #424242;
    }
    .btn-download { 
      background-color: var(--primary-dark);
    }
    
    input[type="file"] {
      display: none;
    }
    
    .history {
      background-color: rgba(27, 27, 27, 0.9);
      border-radius: 7px; /* Reduced from 10px */
      padding: 10.5px; /* Reduced from 15px */
      box-shadow: 0 1.4px 7px rgba(0, 0, 0, 0.2); /* Reduced from 2px 10px */
      height: calc(100% - 21px); /* Reduced from 30px */
      display: flex;
      flex-direction: column;
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10.5px; /* Reduced from 15px */
    }
    
    .history-title {
      font-size: 12.6px; /* Reduced from 18px */
      font-weight: 500;
      margin: 0;
    }
    
    .history-count {
      margin-right: 8%;
      font-size: 9.8px; /* Reduced from 14px */
      color: var(--on-surface-secondary);
    }
    
    .history-list {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 10.5px; /* Reduced from 15px */
    }
    
    .empty-history {
      color: var(--on-surface-secondary);
      text-align: center;
      padding: 14px; /* Reduced from 20px */
      font-size: 9.8px; /* Reduced from 14px */
    }
    
    .history-item {
      padding: 7px; /* Reduced from 10px */
      margin-bottom: 5.6px; /* Reduced from 8px */
      background-color: #474747;
      border-radius: 5.6px; /* Reduced from 8px */
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }
    
    .history-item:active {
      background-color: #3c3c3c;
    }
    
    .history-item-content {
      flex: 1;
      word-break: break-all;
      font-size: 9.8px; /* Reduced from 14px */
      padding-right: 5.6px; /* Reduced from 8px */
    }
    
    .history-item-number {
      font-weight: 500;
      margin-right: 5.6px; /* Reduced from 8px */
      color: var(--secondary);
      min-width: 14px; /* Reduced from 20px */
    }
    
    .history-item-actions {
      display: flex;
      gap: 5.6px; /* Reduced from 8px */
    }
    
    .history-item-btn {
      background: none;
      border: none;
      color: var(--on-surface-secondary);
      cursor: pointer;
      padding: 3.5px; /* Reduced from 5px */
      font-size: 11.2px; /* Reduced from 16px */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .history-item-btn:active {
      color: var(--on-surface);
    }
    
    .history-controls {
      display: flex;
      gap: 7px; /* Reduced from 10px */
      margin-top: 7px; /* Reduced from 10px */
    }
    
    .history-btn {
      flex: 1;
      padding: 7px; /* Reduced from 10px */
      font-size: 9.8px; /* Reduced from 14px */
      font-weight: bold;
      border: none;
      border-radius: 3.5px; /* Reduced from 5px */
      color: #fff;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 3.5px; /* Reduced from 5px */
    }
    
    .history-clear {
      background-color: var(--error);
    }
    
    .history-download {
      background-color: var(--primary);
    }
    
    .toast {
      position: fixed;
      bottom: 14px; /* Reduced from 20px */
      left: 50%;
      transform: translateX(-50%);
      background-color: #3c3c3c;
      color: white;
      padding: 8.4px 16.8px; /* Reduced from 12px 24px */
      border-radius: 3.5px; /* Reduced from 5px */
      font-size: 9.8px; /* Reduced from 14px */
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 80%;
      text-align: center;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    .disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    .error-text {
      color: var(--error-text);
    }
    
    @media (max-width: 768px) {
      .history-section {
        width: 85%;
      }
      
      .btn {
        padding: 7px 10.5px; /* Reduced from 10px 15px */
        font-size: 8.4px; /* Reduced from 12px */
        min-width: 49px; /* Reduced from 70px */
      }
      
      .history-btn {
        font-size: 8.4px; /* Reduced from 12px */
      }
    }
    
    @media (max-width: 480px) {
      .controls {
        gap: 3.5px; /* Reduced from 5px */
      }
      
      .btn {
        padding: 5.6px 8.4px; /* Reduced from 8px 12px */
        font-size: 7.7px; /* Reduced from 11px */
        min-width: 42px; /* Reduced from 60px */
      }
      
      .btn-icon {
        font-size: 11.2px; /* Reduced from 16px */
        margin-bottom: 2.1px; /* Reduced from 3px */
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <button class="toggle-history" onclick="toggleHistory()">📋</button>
    
    <div class="scanner-section">
      <p class="status" id="status">Ready to scan</p>
      <div class="timer" id="timer">Time remaining: 30:00</div>
      
      <div class="scanner-container" id="scannerBox">
        <video id="scanner" playsinline></video>
        <div class="scanner-overlay" id="scannerOverlay">
          <div class="scanner-guide"></div>
        </div>
        <div id="result"></div>
      </div>
    </div>

    <div class="controls-container">
      <div class="controls">
        <button class="btn btn-start" onclick="startCamera()" id="startBtn">
          <span class="btn-icon">📷</span>
          <span>Start</span>
        </button>
        <button class="btn btn-stop" onclick="stopCamera()" disabled id="stopBtn">
          <span class="btn-icon">⏹️</span>
          <span>Stop</span>
        </button>
        <button class="btn btn-file" onclick="document.getElementById('fileInput').click()" id="fileBtn">
          <span class="btn-icon">📁</span>
          <span>File</span>
        </button>
      </div>
    </div>
    
    <input type="file" id="fileInput" accept="image/*" />
  </div>
  
  <div class="history-section" id="historySection">
    <div class="history">
      <div class="history-header">
        <h2 class="history-title">Scan History</h2>
        <div class="history-count" id="historyCount">0 items</div>
      </div>
      
      <div class="history-list" id="historyList">
        <div class="empty-history">No scans yet</div>
      </div>
      
      <div class="history-controls">
        <button class="history-btn history-clear" onclick="clearHistory()" id="clearBtn">
          <span>🧹</span>
          <span>Clear All</span>
        </button>
        <button class="history-btn history-download" onclick="downloadPDF()" id="downloadBtn">
          <span>📥</span>
          <span>Download PDF</span>
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>

  <!-- Audio element for beep sound with fallback -->
  <audio id="beepSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-beep-success-872.mp3" type="audio/mpeg">
  </audio>

  <script>
    // DOM Elements
    const video = document.getElementById("scanner");
    const fileInput = document.getElementById("fileInput");
    const resultDiv = document.getElementById("result");
    const scannerBox = document.getElementById("scannerBox");
    const scannerOverlay = document.getElementById("scannerOverlay");
    const statusText = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const fileBtn = document.getElementById("fileBtn");
    const clearBtn = document.getElementById("clearBtn");
    const historyList = document.getElementById("historyList");
    const historyCount = document.getElementById("historyCount");
    const toast = document.getElementById("toast");
    const beepSound = document.getElementById("beepSound");
    const timerDisplay = document.getElementById("timer");
    const downloadBtn = document.getElementById("downloadBtn");
    const historySection = document.getElementById("historySection");

    // App State
    let stream = null;
    let scanning = false;
    let scanHistory = [];
    let currentScanNumber = 1;
    let lastScannedContent = null;
    let duplicateWarningTimeout = null;
    let scannerTimeout = null;
    let scanTimer = null;
    let timeLeft = 30 * 60; // 30 minutes in seconds
    let timerActive = false;
    let isPausedForResultDisplay = false;

    // Initialize from localStorage
    function initializeFromStorage() {
      try {
        const savedHistory = localStorage.getItem('qrScanHistory');
        if (savedHistory) {
          scanHistory = JSON.parse(savedHistory);
          currentScanNumber = scanHistory.length > 0 ? scanHistory[scanHistory.length - 1].number + 1 : 1;
          updateHistoryDisplay();
          updateHistoryCount();
        }
      } catch (e) {
        console.error("Error loading history from storage:", e);
        clearLocalStorage();
      }
    }

    // Clear corrupted localStorage
    function clearLocalStorage() {
      localStorage.removeItem('qrScanHistory');
      scanHistory = [];
      currentScanNumber = 1;
      updateHistoryDisplay();
      updateHistoryCount();
    }

    // Initialize on load
    initializeFromStorage();

    // Event Listeners
    fileInput.addEventListener('change', handleFileUpload);

    // Toggle history panel
    function toggleHistory() {
      historySection.classList.toggle('active');
    }

    // Functions
    function playBeep() {
      try {
        if (beepSound.readyState >= HTMLMediaElement.HAVE_ENOUGH_DATA) {
          beepSound.currentTime = 0;
          beepSound.play().catch(e => console.log("Beep play error:", e));
        }
      } catch (e) {
        console.log("Beep error:", e);
      }
    }

    function vibrate() {
      // Check if vibration API is supported
      if (navigator.vibrate) {
        // Vibrate for 1 second (500ms)
        navigator.vibrate(1000);
      }
    }

    function startTimer() {
      timerDisplay.style.display = 'block';
      timeLeft = 30 * 60; // 30 minutes in seconds
      timerActive = true;
      updateTimerDisplay();
      
      scanTimer = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
          stopTimer();
          disableAllButtonsExceptPDF();
        }
      }, 1000); // Update every second
    }
    
    function stopTimer() {
      if (scanTimer) {
        clearInterval(scanTimer);
        scanTimer = null;
      }
      timerActive = false;
      timerDisplay.textContent = "Time expired";
    }
    
    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerDisplay.textContent = `Time remaining: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function disableAllButtonsExceptPDF() {
      fileBtn.disabled = true;
      startBtn.disabled = true;
      stopBtn.disabled = true;
      clearBtn.disabled = true;
      
      fileBtn.classList.add('disabled');
      startBtn.classList.add('disabled');
      stopBtn.classList.add('disabled');
      clearBtn.classList.add('disabled');
      
      stopCamera();
      
      showStatus("Scanning time expired");
      showToast("Scanning time has ended.");
    }

    function enableAllButtons() {
      fileBtn.disabled = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      clearBtn.disabled = scanHistory.length === 0;
      
      fileBtn.classList.remove('disabled');
      startBtn.classList.remove('disabled');
      stopBtn.classList.remove('disabled');
      clearBtn.classList.remove('disabled');
      
      timerDisplay.style.display = 'none';
      timerActive = false;
      if (scanTimer) {
        clearInterval(scanTimer);
        scanTimer = null;
      }
      
      showStatus("Ready to scan");
      showToast("Buttons re-enabled");
    }

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      showStatus("Processing image...");
      
      const reader = new FileReader();
      reader.onload = function(ev) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          
          // Set canvas dimensions to match the image
          canvas.width = img.width;
          canvas.height = img.height;
          
          // Draw the image on the canvas
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          
          try {
            // Get the image data from the canvas
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Try to decode the QR code with different options
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
              inversionAttempts: "attemptBoth", // Try both normal and inverted
            });
            
            if (code) {
              playBeep();
              vibrate(); // Add vibration on successful scan
              processScannedCode(code.data);
              if (!timerActive) {
                startTimer();
              }
            } else {
              // If no QR code found, try with a different approach
              showCurrentResult("❌ No QR code found");
              showStatus("No QR code in image", true);
              
              // Additional debugging: try to enhance the image and try again
              tryEnhancedDetection(canvas, ctx);
            }
          } catch (error) {
            showCurrentResult("❌ Error processing image");
            showStatus("Image processing error", true);
            console.error(error);
          }
        };
        img.onerror = () => {
          showCurrentResult("❌ Invalid image");
          showStatus("Invalid image file", true);
        };
        img.src = ev.target.result;
      };
      reader.onerror = () => {
        showCurrentResult("❌ Error reading file");
        showStatus("File read error", true);
      };
      reader.readAsDataURL(file);
    }

    // Enhanced detection function for difficult QR codes
    function tryEnhancedDetection(canvas, ctx) {
      // Create a temporary canvas for image processing
      const tempCanvas = document.createElement("canvas");
      const tempCtx = tempCanvas.getContext("2d");
      
      // Set dimensions
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      
      // Try different image processing techniques
      const techniques = [
        () => {
          // Technique 1: Convert to grayscale
          tempCtx.drawImage(canvas, 0, 0);
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const data = imageData.data;
          
          for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            data[i] = avg;
            data[i + 1] = avg;
            data[i + 2] = avg;
          }
          tempCtx.putImageData(imageData, 0, 0);
          return tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        },
        () => {
          // Technique 2: Increase contrast
          tempCtx.drawImage(canvas, 0, 0);
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const data = imageData.data;
          const factor = 1.5;
          
          for (let i = 0; i < data.length; i += 4) {
            data[i] = factor * (data[i] - 128) + 128;
            data[i + 1] = factor * (data[i + 1] - 128) + 128;
            data[i + 2] = factor * (data[i + 2] - 128) + 128;
          }
          tempCtx.putImageData(imageData, 0, 0);
          return tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        },
        () => {
          // Technique 3: Try with original image but different settings
          return ctx.getImageData(0, 0, canvas.width, canvas.height);
        }
      ];
      
      // Try each technique
      for (let i = 0; i < techniques.length; i++) {
        try {
          const processedImageData = techniques[i]();
          const code = jsQR(processedImageData.data, processedImageData.width, processedImageData.height, {
            inversionAttempts: "attemptBoth",
          });
          
          if (code) {
            playBeep();
            vibrate(); // Add vibration on successful scan
            processScannedCode(code.data);
            if (!timerActive) {
              startTimer();
            }
            return;
          }
        } catch (error) {
          console.log("Enhanced technique failed:", error);
        }
      }
    }

    function startCamera() {
      if (timerActive && timeLeft <= 0) {
        showToast("Scanning time has expired");
        return;
      }

      resultDiv.style.display = 'none';
      showStatus("Starting camera...");
      stopBtn.disabled = false;
      startBtn.disabled = true;
      fileBtn.disabled = true;
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showStatus("Camera not supported", true);
        startBtn.disabled = false;
        fileBtn.disabled = false;
        return;
      }

      if (!timerActive) {
        startTimer();
      }

      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      })
      .then(s => {
        stream = s;
        video.srcObject = stream;
        video.style.display = 'block';
        scannerOverlay.style.display = 'block';
        scannerBox.classList.add('active');
        showStatus("Scanning..");
        
        video.onplaying = () => {
          scanning = true;
          scanFrame();
        };
        
        video.onerror = () => {
          showStatus("Camera error", true);
          stopCamera();
        };
        
        video.play().catch(err => {
          showStatus("Error starting camera", true);
          console.error(err);
          stopCamera();
        });
      })
      .catch(err => {
        showStatus("Camera access denied", true);
        console.error(err);
        startBtn.disabled = false;
        fileBtn.disabled = false;
        
        if (err.name === 'NotAllowedError') {
          showToast("Please enable camera permissions in your browser settings");
        }
      });
    }

    function stopCamera() {
      scanning = false;
      stopBtn.disabled = true;
      startBtn.disabled = false;
      fileBtn.disabled = false;
      video.pause();
      video.style.display = 'none';
      scannerOverlay.style.display = 'none';
      scannerBox.classList.remove('active');
      showStatus("Camera stopped");
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      if (scannerTimeout) {
        clearTimeout(scannerTimeout);
        scannerTimeout = null;
      }
    }

    function scanFrame() {
      if (!scanning || isPausedForResultDisplay || (timerActive && timeLeft <= 0)) {
        return;
      }
      
      try {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height, {
            inversionAttempts: "dontInvert",
          });
          
          if (code) {
            playBeep();
            vibrate(); // Add vibration on successful scan
            processScannedCode(code.data);
            return;
          }
        }
        scannerTimeout = requestAnimationFrame(scanFrame);
      } catch (error) {
        console.error("Scan error:", error);
        showStatus("Scan error occurred", true);
        stopCamera();
      }
    }

    function processScannedCode(content) {
      if (!content || content.trim() === "") {
        showCurrentResult("❌ Empty QR code");
        showStatus("Empty QR code content", true);
        return;
      }

      if (content === lastScannedContent) {
        showDuplicateWarning();
        return;
      }

      const isDuplicate = scanHistory.some(item => item.content === content);
      
      if (isDuplicate) {
        showDuplicateWarning();
        return;
      }

      lastScannedContent = content;
      addToHistory(content);
      showCurrentResult(content);
      showStatus("Scan successful!");
      showToast("QR code scanned!", 3000);
      
      isPausedForResultDisplay = true;
      setTimeout(() => {
        isPausedForResultDisplay = false;
        resultDiv.style.display = 'none';
        showStatus("Ready to scan...");
        if (scanning) {
          scanFrame();
        }
      }, 2000);
    }

    function showDuplicateWarning() {
      showStatus("Duplicate detected!", true);
      showCurrentResult("⚠️ Duplicate QR");
      
      if (duplicateWarningTimeout) {
        clearTimeout(duplicateWarningTimeout);
      }
      duplicateWarningTimeout = setTimeout(() => {
        showStatus("Ready to scan.");
        resultDiv.style.display = 'none';
      }, 3000);
    }

    function addToHistory(content) {
      if (!content || content.startsWith("❌")) return;
      
      const timestamp = new Date().toLocaleString();
      const scanItem = {
        number: currentScanNumber++,
        content: content,
        timestamp: timestamp
      };
      
      scanHistory.push(scanItem);
      updateHistoryDisplay();
      updateHistoryCount();
      saveHistory();
    }

    function showCurrentResult(text) {
      resultDiv.innerHTML = text;
      resultDiv.style.display = 'block';
    }

    function updateHistoryDisplay() {
      if (scanHistory.length === 0) {
        historyList.innerHTML = '<div class="empty-history">No scans yet</div>';
        return;
      }

      historyList.innerHTML = '';
      scanHistory.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.innerHTML = `
          <div class="history-item-number">${item.number}.</div>
          <div class="history-item-content">${item.content}</div>
          <div class="history-item-actions">
            <button class="history-item-btn" onclick="deleteHistoryItem(${item.number}, event)" title="Delete">✕</button>
          </div>
        `;
        historyList.appendChild(historyItem);
      });
      
      historyList.scrollTop = historyList.scrollHeight;
    }
    
    function updateHistoryCount() {
      const count = scanHistory.length;
      historyCount.textContent = `${count} ${count === 1 ? 'item' : 'items'}`;
      downloadBtn.disabled = count === 0;
      clearBtn.disabled = count === 0;
    }

    // Function to extract data from QR content
    function extractDataFromContent(content) {
      // Try to parse as JSON first
      try {
        const data = JSON.parse(content);
        return {
          name: data.name || data.fullName || data.Name || data.FullName || data.nama || data.Nama || "",
          phone: data.phone || data.mobile || data.Phone || data.Mobile || data.telepon || data.Telepon || "",
          gender: data.gender || data.Gender || data.sex || data.Sex || data.jenis_kelamin || data.Jenis_Kelamin || "",
          timestamp: new Date().toLocaleString()
        };
      } catch (e) {
        // If not JSON, try to extract from text pattern
        // Specifically look for "full name:" pattern (case insensitive)
        const nameMatch = content.match(/full name[:=\s]*([^\n,]+)/i);
        const phoneMatch = content.match(/(?:phone|mobile|tel|telepon|telefono|hp|handphone)[:=\s]*([+\d\s\-()]+)/i);
        const genderMatch = content.match(/(?:gender|sex|jenis kelamin|género)[:=\s]*([^\n,]+)/i);
        
        // Extract name specifically after "full name:"
        let extractedName = nameMatch ? nameMatch[1].trim() : "";
        
        // If no explicit name field found, try to find the first line that looks like a name
        if (!extractedName) {
          const lines = content.split('\n');
          for (const line of lines) {
            // A name typically has letters, spaces, and possibly dots for initials
            if (line.match(/^[A-Za-z\s\.]+$/) && line.trim().length > 3) {
              extractedName = line.trim();
              break;
            }
          }
        }
        
        return {
          name: extractedName,
          phone: phoneMatch ? phoneMatch[1].trim() : "",
          gender: genderMatch ? genderMatch[1].trim() : "",
          timestamp: new Date().toLocaleString()
        };
      }
    }

    function downloadPDF() {
      if (scanHistory.length === 0) {
        showToast("No scans to download");
        return;
      }

      try {
        // Create a new jsPDF instance
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Set title
        doc.setFontSize(16);
        doc.text("QR Code Scan History", 105, 15, { align: "center" });
        
        // Add date
        doc.setFontSize(10);
        const date = new Date().toLocaleDateString();
        doc.text(`Generated on: ${date}`, 105, 22, { align: "center" });
        
        // Extract data from scan history
        const tableData = scanHistory.map((item, index) => {
          const extractedData = extractDataFromContent(item.content);
          return [
            index + 1,
            extractedData.name || "N/A",
            extractedData.phone || "N/A",
            extractedData.gender || "N/A",
            extractedData.timestamp
          ];
        });
        
        // Create the table
        doc.autoTable({
          head: [['#', 'First Name', 'Phone', 'Gender', 'Date']],
          body: tableData,
          startY: 30,
          theme: 'grid',
          styles: {
            fontSize: 8,
            cellPadding: 2,
            overflow: 'linebreak'
          },
          headStyles: {
            fillColor: [99, 0, 238],
            textColor: 255,
            fontStyle: 'bold'
          },
          alternateRowStyles: {
            fillColor: [240, 240, 240]
          },
          columnStyles: {
            0: { cellWidth: 12 },
            1: { cellWidth: 35 },
            2: { cellWidth: 35 },
            3: { cellWidth: 25 },
            4: { cellWidth: 45 }
          }
        });
        
        // Save the PDF
        const dateStr = new Date().toISOString().slice(0, 10);
        doc.save(`QR_Scan_History_${dateStr}.pdf`);

        showToast("PDF file downloaded");
        
      } catch (e) {
        console.error("PDF export error:", e);
        showToast("Error generating PDF file", true);
      }
    }

    function clearHistoryAfterDownload() {
      // Clear the history
      scanHistory = [];
      currentScanNumber = 1;
      lastScannedContent = null;
      updateHistoryDisplay();
      updateHistoryCount();
      saveHistory();
      
      // Stop camera and timer
      stopCamera();
      stopTimer();
      
      // Reset timer display
      timerDisplay.textContent = "Time remaining: 30:00";
      timerDisplay.style.display = 'none';
      
      // Enable all buttons
      enableAllButtons();
      
      showStatus("Ready to scan");
      showToast("History cleared and scanner reset");
    }

    function deleteHistoryItem(number, event) {
      event.stopPropagation();
      scanHistory = scanHistory.filter(i => i.number !== number);
      updateHistoryDisplay();
      updateHistoryCount();
      saveHistory();
      showToast("Item deleted");
    }

    function clearHistory() {
      if (scanHistory.length === 0) {
        showToast("History is already empty");
        return;
      }
      
      if (confirm("Are you sure you want to clear all scan history?")) {
        scanHistory = [];
        currentScanNumber = 1;
        lastScannedContent = null;
        updateHistoryDisplay();
        updateHistoryCount();
        saveHistory();
        showToast("History cleared");
      }
    }

    function saveHistory() {
      try {
        localStorage.setItem('qrScanHistory', JSON.stringify(scanHistory));
      } catch (e) {
        console.error("Error saving history:", e);
        showToast("Error saving history", true);
      }
    }
    
    function showStatus(message, isError = false) {
      statusText.textContent = message;
      statusText.className = isError ? 'status error-text' : 'status';
    }
    
    function showToast(message, duration = 2000, isError = false) {
      toast.textContent = message;
      toast.className = isError ? 'toast error-text' : 'toast';
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      stopCamera();
      stopTimer();
      if (duplicateWarningTimeout) {
        clearTimeout(duplicateWarningTimeout);
      }
      if (scannerTimeout) {
        cancelAnimationFrame(scannerTimeout);
      }
    });

    // Initialize button states
    updateHistoryCount();
  </script>
</body>
</html>